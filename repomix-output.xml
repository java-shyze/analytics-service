This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.mvn/
  wrapper/
    maven-wrapper.properties
src/
  main/
    java/
      com/
        analytics/
          config/
            KafkaConsumerConfig.java
          controller/
            AnalyticsController.java
          dto/
            LinkAnalyticsResponse.java
            LinkClickEvent.java
            TimeSeriesData.java
          model/
            LinkClick.java
          repository/
            LinkClickRepository.java
          service/
            AnalyticsService.java
            KafkaListenerService.java
            UserAgentParserService.java
          AnalyticsApplication.java
    resources/
      application.properties
  test/
    java/
      com/
        analytics/
          analytics_service/
            AnalyticsServiceApplicationTests.java
.env.example
.gitattributes
.gitignore
compose.yaml
dockerfile
justfile
mvnw
mvnw.cmd
pom.xml
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".mvn/wrapper/maven-wrapper.properties">
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip
</file>

<file path="src/main/java/com/analytics/config/KafkaConsumerConfig.java">
package com.analytics.config;

import com.analytics.dto.LinkClickEvent;
import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.common.serialization.StringDeserializer;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.kafka.annotation.EnableKafka;
import org.springframework.kafka.config.ConcurrentKafkaListenerContainerFactory;
import org.springframework.kafka.core.ConsumerFactory;
import org.springframework.kafka.core.DefaultKafkaConsumerFactory;
import org.springframework.kafka.support.serializer.JsonDeserializer;

import java.util.HashMap;
import java.util.Map;

@Configuration
@EnableKafka
public class KafkaConsumerConfig {

    @Value("${spring.kafka.bootstrap-servers}")
    private String bootstrapServers;

    @Value("${spring.kafka.consumer.group-id}")
    private String groupId;

    @Bean
    public ConsumerFactory<String, LinkClickEvent> consumerFactory() {
        JsonDeserializer<LinkClickEvent> valueDeserializer =
                new JsonDeserializer<>(LinkClickEvent.class);
        valueDeserializer.addTrustedPackages("*");

        Map<String, Object> props = new HashMap<>();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        props.put(ConsumerConfig.GROUP_ID_CONFIG, groupId);
        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");

        return new DefaultKafkaConsumerFactory<>(
                props,
                new StringDeserializer(),
                valueDeserializer
        );
    }

    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, LinkClickEvent> kafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, LinkClickEvent> factory =
                new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(consumerFactory());
        return factory;
    }
}
</file>

<file path="src/main/java/com/analytics/dto/LinkClickEvent.java">
package com.analytics.dto;

import com.fasterxml.jackson.annotation.JsonFormat;
import java.time.LocalDateTime;

public class LinkClickEvent {
    private Long linkId;
    private String alias;
    private String originalUrl;
    private String ipAddress;
    private String userAgent;
    private String referer;
    private String country;
    private String city;
    
    @JsonFormat(pattern = "yyyy-MM-dd'T'HH:mm:ss")
    private LocalDateTime clickedAt;

    public LinkClickEvent() {}

    // Getters and Setters
    public Long getLinkId() { return linkId; }
    public void setLinkId(Long linkId) { this.linkId = linkId; }
    
    public String getAlias() { return alias; }
    public void setAlias(String alias) { this.alias = alias; }
    
    public String getOriginalUrl() { return originalUrl; }
    public void setOriginalUrl(String originalUrl) { this.originalUrl = originalUrl; }
    
    public String getIpAddress() { return ipAddress; }
    public void setIpAddress(String ipAddress) { this.ipAddress = ipAddress; }
    
    public String getUserAgent() { return userAgent; }
    public void setUserAgent(String userAgent) { this.userAgent = userAgent; }
    
    public String getReferer() { return referer; }
    public void setReferer(String referer) { this.referer = referer; }
    
    public String getCountry() { return country; }
    public void setCountry(String country) { this.country = country; }
    
    public String getCity() { return city; }
    public void setCity(String city) { this.city = city; }
    
    public LocalDateTime getClickedAt() { return clickedAt; }
    public void setClickedAt(LocalDateTime clickedAt) { this.clickedAt = clickedAt; }
}
</file>

<file path="src/main/java/com/analytics/dto/TimeSeriesData.java">
package com.analytics.dto;

public class TimeSeriesData {
    private String date;
    private long count;

    public TimeSeriesData() {}

    public TimeSeriesData(String date, long count) {
        this.date = date;
        this.count = count;
    }

    public String getDate() { return date; }
    public void setDate(String date) { this.date = date; }

    public long getCount() { return count; }
    public void setCount(long count) { this.count = count; }
}
</file>

<file path="src/main/java/com/analytics/service/KafkaListenerService.java">
package com.analytics.service;

import com.analytics.dto.LinkClickEvent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.stereotype.Service;

@Service
public class KafkaListenerService {

    private static final Logger log = LoggerFactory.getLogger(KafkaListenerService.class);

    private final AnalyticsService analyticsService;

    public KafkaListenerService(AnalyticsService analyticsService) {
        this.analyticsService = analyticsService;
    }

    @KafkaListener(
            topics = "${kafka.topic.link-clicks}",
            groupId = "${spring.kafka.consumer.group-id}"
    )
    public void onMessage(LinkClickEvent event) {
        log.info("Received Kafka click event: alias={}, ip={}", event.getAlias(), event.getIpAddress());

        analyticsService.saveClick(
                event.getLinkId(),
                event.getAlias(),
                event.getOriginalUrl(),
                event.getIpAddress(),
                event.getUserAgent(),
                event.getReferer()
        );
    }
}
</file>

<file path="src/main/java/com/analytics/AnalyticsApplication.java">
package com.analytics;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class AnalyticsApplication {

    public static void main(String[] args) {
        SpringApplication.run(AnalyticsApplication.class, args);
    }
}
</file>

<file path="src/test/java/com/analytics/analytics_service/AnalyticsServiceApplicationTests.java">
package com.analytics.analytics_service;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class AnalyticsServiceApplicationTests {

	@Test
	void contextLoads() {
	}

}
</file>

<file path=".env.example">
LINK_DB_URL=jdbc:postgresql://link-db:5432/linkdb
LINK_DB_NAME=linkdb
LINK_DB_USERNAME=linkuser
LINK_DB_PASSWORD=linkpass123
LINK_DB_LIQUIBASE_ENABLED=false
LINK_DB_MAXIMUM-POOL-SIZE=10

ANALYTICS_DB_URL=jdbc:postgresql://analytics-db:5432/analyticsdb
ANALYTICS_DB_NAME=analyticsdb
ANALYTICS_DB_USERNAME=analyticsuser
ANALYTICS_DB_PASSWORD=analyticspass123

KAFKA_BOOTSTRAP_SERVERS=kafka:9092
</file>

<file path=".gitattributes">
/mvnw text eol=lf
*.cmd text eol=crlf
</file>

<file path="dockerfile">
FROM maven:3.9.9-eclipse-temurin-21 AS builder
WORKDIR /app
COPY pom.xml .
COPY src src/
RUN mvn clean package -DskipTests

FROM eclipse-temurin:21-jre-alpine
WORKDIR /app
COPY --from=builder /app/target/*.jar app.jar
EXPOSE 8081
ENTRYPOINT ["java", "-jar", "app.jar"]
</file>

<file path="justfile">
up:
    @echo "Запуск сервисов..."
    docker compose up -d

down:
    @echo "Остановка сервисов..."
    docker compose down

logs:
    @echo "Просмотр логов..."
    docker compose logs -f

rebuild:
    @echo "Пересборка образов и запуск контейнера"
    docker compose build
    docker compose up -d

fresh-start:
    @echo "Холодный запуск сервисов..."
    docker compose down -v
    docker compose build
    docker compose up -d
</file>

<file path="mvnw">
#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup batch script, version 3.3.4
#
# Optional ENV vars
# -----------------
#   JAVA_HOME - location of a JDK home dir, required when download maven via java source
#   MVNW_REPOURL - repo url base for downloading maven distribution
#   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
#   MVNW_VERBOSE - true: enable verbose log; debug: trace the mvnw script; others: silence the output
# ----------------------------------------------------------------------------

set -euf
[ "${MVNW_VERBOSE-}" != debug ] || set -x

# OS specific support.
native_path() { printf %s\\n "$1"; }
case "$(uname)" in
CYGWIN* | MINGW*)
  [ -z "${JAVA_HOME-}" ] || JAVA_HOME="$(cygpath --unix "$JAVA_HOME")"
  native_path() { cygpath --path --windows "$1"; }
  ;;
esac

# set JAVACMD and JAVACCMD
set_java_home() {
  # For Cygwin and MinGW, ensure paths are in Unix format before anything is touched
  if [ -n "${JAVA_HOME-}" ]; then
    if [ -x "$JAVA_HOME/jre/sh/java" ]; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
      JAVACCMD="$JAVA_HOME/jre/sh/javac"
    else
      JAVACMD="$JAVA_HOME/bin/java"
      JAVACCMD="$JAVA_HOME/bin/javac"

      if [ ! -x "$JAVACMD" ] || [ ! -x "$JAVACCMD" ]; then
        echo "The JAVA_HOME environment variable is not defined correctly, so mvnw cannot run." >&2
        echo "JAVA_HOME is set to \"$JAVA_HOME\", but \"\$JAVA_HOME/bin/java\" or \"\$JAVA_HOME/bin/javac\" does not exist." >&2
        return 1
      fi
    fi
  else
    JAVACMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v java
    )" || :
    JAVACCMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v javac
    )" || :

    if [ ! -x "${JAVACMD-}" ] || [ ! -x "${JAVACCMD-}" ]; then
      echo "The java/javac command does not exist in PATH nor is JAVA_HOME set, so mvnw cannot run." >&2
      return 1
    fi
  fi
}

# hash string like Java String::hashCode
hash_string() {
  str="${1:-}" h=0
  while [ -n "$str" ]; do
    char="${str%"${str#?}"}"
    h=$(((h * 31 + $(LC_CTYPE=C printf %d "'$char")) % 4294967296))
    str="${str#?}"
  done
  printf %x\\n $h
}

verbose() { :; }
[ "${MVNW_VERBOSE-}" != true ] || verbose() { printf %s\\n "${1-}"; }

die() {
  printf %s\\n "$1" >&2
  exit 1
}

trim() {
  # MWRAPPER-139:
  #   Trims trailing and leading whitespace, carriage returns, tabs, and linefeeds.
  #   Needed for removing poorly interpreted newline sequences when running in more
  #   exotic environments such as mingw bash on Windows.
  printf "%s" "${1}" | tr -d '[:space:]'
}

scriptDir="$(dirname "$0")"
scriptName="$(basename "$0")"

# parse distributionUrl and optional distributionSha256Sum, requires .mvn/wrapper/maven-wrapper.properties
while IFS="=" read -r key value; do
  case "${key-}" in
  distributionUrl) distributionUrl=$(trim "${value-}") ;;
  distributionSha256Sum) distributionSha256Sum=$(trim "${value-}") ;;
  esac
done <"$scriptDir/.mvn/wrapper/maven-wrapper.properties"
[ -n "${distributionUrl-}" ] || die "cannot read distributionUrl property in $scriptDir/.mvn/wrapper/maven-wrapper.properties"

case "${distributionUrl##*/}" in
maven-mvnd-*bin.*)
  MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/
  case "${PROCESSOR_ARCHITECTURE-}${PROCESSOR_ARCHITEW6432-}:$(uname -a)" in
  *AMD64:CYGWIN* | *AMD64:MINGW*) distributionPlatform=windows-amd64 ;;
  :Darwin*x86_64) distributionPlatform=darwin-amd64 ;;
  :Darwin*arm64) distributionPlatform=darwin-aarch64 ;;
  :Linux*x86_64*) distributionPlatform=linux-amd64 ;;
  *)
    echo "Cannot detect native platform for mvnd on $(uname)-$(uname -m), use pure java version" >&2
    distributionPlatform=linux-amd64
    ;;
  esac
  distributionUrl="${distributionUrl%-bin.*}-$distributionPlatform.zip"
  ;;
maven-mvnd-*) MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/ ;;
*) MVN_CMD="mvn${scriptName#mvnw}" _MVNW_REPO_PATTERN=/org/apache/maven/ ;;
esac

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
[ -z "${MVNW_REPOURL-}" ] || distributionUrl="$MVNW_REPOURL$_MVNW_REPO_PATTERN${distributionUrl#*"$_MVNW_REPO_PATTERN"}"
distributionUrlName="${distributionUrl##*/}"
distributionUrlNameMain="${distributionUrlName%.*}"
distributionUrlNameMain="${distributionUrlNameMain%-bin}"
MAVEN_USER_HOME="${MAVEN_USER_HOME:-${HOME}/.m2}"
MAVEN_HOME="${MAVEN_USER_HOME}/wrapper/dists/${distributionUrlNameMain-}/$(hash_string "$distributionUrl")"

exec_maven() {
  unset MVNW_VERBOSE MVNW_USERNAME MVNW_PASSWORD MVNW_REPOURL || :
  exec "$MAVEN_HOME/bin/$MVN_CMD" "$@" || die "cannot exec $MAVEN_HOME/bin/$MVN_CMD"
}

if [ -d "$MAVEN_HOME" ]; then
  verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  exec_maven "$@"
fi

case "${distributionUrl-}" in
*?-bin.zip | *?maven-mvnd-?*-?*.zip) ;;
*) die "distributionUrl is not valid, must match *-bin.zip or maven-mvnd-*.zip, but found '${distributionUrl-}'" ;;
esac

# prepare tmp dir
if TMP_DOWNLOAD_DIR="$(mktemp -d)" && [ -d "$TMP_DOWNLOAD_DIR" ]; then
  clean() { rm -rf -- "$TMP_DOWNLOAD_DIR"; }
  trap clean HUP INT TERM EXIT
else
  die "cannot create temp dir"
fi

mkdir -p -- "${MAVEN_HOME%/*}"

# Download and Install Apache Maven
verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
verbose "Downloading from: $distributionUrl"
verbose "Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName"

# select .zip or .tar.gz
if ! command -v unzip >/dev/null; then
  distributionUrl="${distributionUrl%.zip}.tar.gz"
  distributionUrlName="${distributionUrl##*/}"
fi

# verbose opt
__MVNW_QUIET_WGET=--quiet __MVNW_QUIET_CURL=--silent __MVNW_QUIET_UNZIP=-q __MVNW_QUIET_TAR=''
[ "${MVNW_VERBOSE-}" != true ] || __MVNW_QUIET_WGET='' __MVNW_QUIET_CURL='' __MVNW_QUIET_UNZIP='' __MVNW_QUIET_TAR=v

# normalize http auth
case "${MVNW_PASSWORD:+has-password}" in
'') MVNW_USERNAME='' MVNW_PASSWORD='' ;;
has-password) [ -n "${MVNW_USERNAME-}" ] || MVNW_USERNAME='' MVNW_PASSWORD='' ;;
esac

if [ -z "${MVNW_USERNAME-}" ] && command -v wget >/dev/null; then
  verbose "Found wget ... using wget"
  wget ${__MVNW_QUIET_WGET:+"$__MVNW_QUIET_WGET"} "$distributionUrl" -O "$TMP_DOWNLOAD_DIR/$distributionUrlName" || die "wget: Failed to fetch $distributionUrl"
elif [ -z "${MVNW_USERNAME-}" ] && command -v curl >/dev/null; then
  verbose "Found curl ... using curl"
  curl ${__MVNW_QUIET_CURL:+"$__MVNW_QUIET_CURL"} -f -L -o "$TMP_DOWNLOAD_DIR/$distributionUrlName" "$distributionUrl" || die "curl: Failed to fetch $distributionUrl"
elif set_java_home; then
  verbose "Falling back to use Java to download"
  javaSource="$TMP_DOWNLOAD_DIR/Downloader.java"
  targetZip="$TMP_DOWNLOAD_DIR/$distributionUrlName"
  cat >"$javaSource" <<-END
	public class Downloader extends java.net.Authenticator
	{
	  protected java.net.PasswordAuthentication getPasswordAuthentication()
	  {
	    return new java.net.PasswordAuthentication( System.getenv( "MVNW_USERNAME" ), System.getenv( "MVNW_PASSWORD" ).toCharArray() );
	  }
	  public static void main( String[] args ) throws Exception
	  {
	    setDefault( new Downloader() );
	    java.nio.file.Files.copy( java.net.URI.create( args[0] ).toURL().openStream(), java.nio.file.Paths.get( args[1] ).toAbsolutePath().normalize() );
	  }
	}
	END
  # For Cygwin/MinGW, switch paths to Windows format before running javac and java
  verbose " - Compiling Downloader.java ..."
  "$(native_path "$JAVACCMD")" "$(native_path "$javaSource")" || die "Failed to compile Downloader.java"
  verbose " - Running Downloader.java ..."
  "$(native_path "$JAVACMD")" -cp "$(native_path "$TMP_DOWNLOAD_DIR")" Downloader "$distributionUrl" "$(native_path "$targetZip")"
fi

# If specified, validate the SHA-256 sum of the Maven distribution zip file
if [ -n "${distributionSha256Sum-}" ]; then
  distributionSha256Result=false
  if [ "$MVN_CMD" = mvnd.sh ]; then
    echo "Checksum validation is not supported for maven-mvnd." >&2
    echo "Please disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  elif command -v sha256sum >/dev/null; then
    if echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | sha256sum -c - >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  elif command -v shasum >/dev/null; then
    if echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | shasum -a 256 -c >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  else
    echo "Checksum validation was requested but neither 'sha256sum' or 'shasum' are available." >&2
    echo "Please install either command, or disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  fi
  if [ $distributionSha256Result = false ]; then
    echo "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised." >&2
    echo "If you updated your Maven version, you need to update the specified distributionSha256Sum property." >&2
    exit 1
  fi
fi

# unzip and move
if command -v unzip >/dev/null; then
  unzip ${__MVNW_QUIET_UNZIP:+"$__MVNW_QUIET_UNZIP"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -d "$TMP_DOWNLOAD_DIR" || die "failed to unzip"
else
  tar xzf${__MVNW_QUIET_TAR:+"$__MVNW_QUIET_TAR"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -C "$TMP_DOWNLOAD_DIR" || die "failed to untar"
fi

# Find the actual extracted directory name (handles snapshots where filename != directory name)
actualDistributionDir=""

# First try the expected directory name (for regular distributions)
if [ -d "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain" ]; then
  if [ -f "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain/bin/$MVN_CMD" ]; then
    actualDistributionDir="$distributionUrlNameMain"
  fi
fi

# If not found, search for any directory with the Maven executable (for snapshots)
if [ -z "$actualDistributionDir" ]; then
  # enable globbing to iterate over items
  set +f
  for dir in "$TMP_DOWNLOAD_DIR"/*; do
    if [ -d "$dir" ]; then
      if [ -f "$dir/bin/$MVN_CMD" ]; then
        actualDistributionDir="$(basename "$dir")"
        break
      fi
    fi
  done
  set -f
fi

if [ -z "$actualDistributionDir" ]; then
  verbose "Contents of $TMP_DOWNLOAD_DIR:"
  verbose "$(ls -la "$TMP_DOWNLOAD_DIR")"
  die "Could not find Maven distribution directory in extracted archive"
fi

verbose "Found extracted Maven distribution directory: $actualDistributionDir"
printf %s\\n "$distributionUrl" >"$TMP_DOWNLOAD_DIR/$actualDistributionDir/mvnw.url"
mv -- "$TMP_DOWNLOAD_DIR/$actualDistributionDir" "$MAVEN_HOME" || [ -d "$MAVEN_HOME" ] || die "fail to move MAVEN_HOME"

clean || :
exec_maven "$@"
</file>

<file path="mvnw.cmd">
<# : batch portion
@REM ----------------------------------------------------------------------------
@REM Licensed to the Apache Software Foundation (ASF) under one
@REM or more contributor license agreements.  See the NOTICE file
@REM distributed with this work for additional information
@REM regarding copyright ownership.  The ASF licenses this file
@REM to you under the Apache License, Version 2.0 (the
@REM "License"); you may not use this file except in compliance
@REM with the License.  You may obtain a copy of the License at
@REM
@REM    http://www.apache.org/licenses/LICENSE-2.0
@REM
@REM Unless required by applicable law or agreed to in writing,
@REM software distributed under the License is distributed on an
@REM "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
@REM KIND, either express or implied.  See the License for the
@REM specific language governing permissions and limitations
@REM under the License.
@REM ----------------------------------------------------------------------------

@REM ----------------------------------------------------------------------------
@REM Apache Maven Wrapper startup batch script, version 3.3.4
@REM
@REM Optional ENV vars
@REM   MVNW_REPOURL - repo url base for downloading maven distribution
@REM   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
@REM   MVNW_VERBOSE - true: enable verbose log; others: silence the output
@REM ----------------------------------------------------------------------------

@IF "%__MVNW_ARG0_NAME__%"=="" (SET __MVNW_ARG0_NAME__=%~nx0)
@SET __MVNW_CMD__=
@SET __MVNW_ERROR__=
@SET __MVNW_PSMODULEP_SAVE=%PSModulePath%
@SET PSModulePath=
@FOR /F "usebackq tokens=1* delims==" %%A IN (`powershell -noprofile "& {$scriptDir='%~dp0'; $script='%__MVNW_ARG0_NAME__%'; icm -ScriptBlock ([Scriptblock]::Create((Get-Content -Raw '%~f0'))) -NoNewScope}"`) DO @(
  IF "%%A"=="MVN_CMD" (set __MVNW_CMD__=%%B) ELSE IF "%%B"=="" (echo %%A) ELSE (echo %%A=%%B)
)
@SET PSModulePath=%__MVNW_PSMODULEP_SAVE%
@SET __MVNW_PSMODULEP_SAVE=
@SET __MVNW_ARG0_NAME__=
@SET MVNW_USERNAME=
@SET MVNW_PASSWORD=
@IF NOT "%__MVNW_CMD__%"=="" ("%__MVNW_CMD__%" %*)
@echo Cannot start maven from wrapper >&2 && exit /b 1
@GOTO :EOF
: end batch / begin powershell #>

$ErrorActionPreference = "Stop"
if ($env:MVNW_VERBOSE -eq "true") {
  $VerbosePreference = "Continue"
}

# calculate distributionUrl, requires .mvn/wrapper/maven-wrapper.properties
$distributionUrl = (Get-Content -Raw "$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionUrl
if (!$distributionUrl) {
  Write-Error "cannot read distributionUrl property in $scriptDir/.mvn/wrapper/maven-wrapper.properties"
}

switch -wildcard -casesensitive ( $($distributionUrl -replace '^.*/','') ) {
  "maven-mvnd-*" {
    $USE_MVND = $true
    $distributionUrl = $distributionUrl -replace '-bin\.[^.]*$',"-windows-amd64.zip"
    $MVN_CMD = "mvnd.cmd"
    break
  }
  default {
    $USE_MVND = $false
    $MVN_CMD = $script -replace '^mvnw','mvn'
    break
  }
}

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
if ($env:MVNW_REPOURL) {
  $MVNW_REPO_PATTERN = if ($USE_MVND -eq $False) { "/org/apache/maven/" } else { "/maven/mvnd/" }
  $distributionUrl = "$env:MVNW_REPOURL$MVNW_REPO_PATTERN$($distributionUrl -replace "^.*$MVNW_REPO_PATTERN",'')"
}
$distributionUrlName = $distributionUrl -replace '^.*/',''
$distributionUrlNameMain = $distributionUrlName -replace '\.[^.]*$','' -replace '-bin$',''

$MAVEN_M2_PATH = "$HOME/.m2"
if ($env:MAVEN_USER_HOME) {
  $MAVEN_M2_PATH = "$env:MAVEN_USER_HOME"
}

if (-not (Test-Path -Path $MAVEN_M2_PATH)) {
    New-Item -Path $MAVEN_M2_PATH -ItemType Directory | Out-Null
}

$MAVEN_WRAPPER_DISTS = $null
if ((Get-Item $MAVEN_M2_PATH).Target[0] -eq $null) {
  $MAVEN_WRAPPER_DISTS = "$MAVEN_M2_PATH/wrapper/dists"
} else {
  $MAVEN_WRAPPER_DISTS = (Get-Item $MAVEN_M2_PATH).Target[0] + "/wrapper/dists"
}

$MAVEN_HOME_PARENT = "$MAVEN_WRAPPER_DISTS/$distributionUrlNameMain"
$MAVEN_HOME_NAME = ([System.Security.Cryptography.SHA256]::Create().ComputeHash([byte[]][char[]]$distributionUrl) | ForEach-Object {$_.ToString("x2")}) -join ''
$MAVEN_HOME = "$MAVEN_HOME_PARENT/$MAVEN_HOME_NAME"

if (Test-Path -Path "$MAVEN_HOME" -PathType Container) {
  Write-Verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  Write-Output "MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD"
  exit $?
}

if (! $distributionUrlNameMain -or ($distributionUrlName -eq $distributionUrlNameMain)) {
  Write-Error "distributionUrl is not valid, must end with *-bin.zip, but found $distributionUrl"
}

# prepare tmp dir
$TMP_DOWNLOAD_DIR_HOLDER = New-TemporaryFile
$TMP_DOWNLOAD_DIR = New-Item -Itemtype Directory -Path "$TMP_DOWNLOAD_DIR_HOLDER.dir"
$TMP_DOWNLOAD_DIR_HOLDER.Delete() | Out-Null
trap {
  if ($TMP_DOWNLOAD_DIR.Exists) {
    try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
    catch { Write-Warning "Cannot remove $TMP_DOWNLOAD_DIR" }
  }
}

New-Item -Itemtype Directory -Path "$MAVEN_HOME_PARENT" -Force | Out-Null

# Download and Install Apache Maven
Write-Verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
Write-Verbose "Downloading from: $distributionUrl"
Write-Verbose "Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName"

$webclient = New-Object System.Net.WebClient
if ($env:MVNW_USERNAME -and $env:MVNW_PASSWORD) {
  $webclient.Credentials = New-Object System.Net.NetworkCredential($env:MVNW_USERNAME, $env:MVNW_PASSWORD)
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
$webclient.DownloadFile($distributionUrl, "$TMP_DOWNLOAD_DIR/$distributionUrlName") | Out-Null

# If specified, validate the SHA-256 sum of the Maven distribution zip file
$distributionSha256Sum = (Get-Content -Raw "$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionSha256Sum
if ($distributionSha256Sum) {
  if ($USE_MVND) {
    Write-Error "Checksum validation is not supported for maven-mvnd. `nPlease disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties."
  }
  Import-Module $PSHOME\Modules\Microsoft.PowerShell.Utility -Function Get-FileHash
  if ((Get-FileHash "$TMP_DOWNLOAD_DIR/$distributionUrlName" -Algorithm SHA256).Hash.ToLower() -ne $distributionSha256Sum) {
    Write-Error "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised. If you updated your Maven version, you need to update the specified distributionSha256Sum property."
  }
}

# unzip and move
Expand-Archive "$TMP_DOWNLOAD_DIR/$distributionUrlName" -DestinationPath "$TMP_DOWNLOAD_DIR" | Out-Null

# Find the actual extracted directory name (handles snapshots where filename != directory name)
$actualDistributionDir = ""

# First try the expected directory name (for regular distributions)
$expectedPath = Join-Path "$TMP_DOWNLOAD_DIR" "$distributionUrlNameMain"
$expectedMvnPath = Join-Path "$expectedPath" "bin/$MVN_CMD"
if ((Test-Path -Path $expectedPath -PathType Container) -and (Test-Path -Path $expectedMvnPath -PathType Leaf)) {
  $actualDistributionDir = $distributionUrlNameMain
}

# If not found, search for any directory with the Maven executable (for snapshots)
if (!$actualDistributionDir) {
  Get-ChildItem -Path "$TMP_DOWNLOAD_DIR" -Directory | ForEach-Object {
    $testPath = Join-Path $_.FullName "bin/$MVN_CMD"
    if (Test-Path -Path $testPath -PathType Leaf) {
      $actualDistributionDir = $_.Name
    }
  }
}

if (!$actualDistributionDir) {
  Write-Error "Could not find Maven distribution directory in extracted archive"
}

Write-Verbose "Found extracted Maven distribution directory: $actualDistributionDir"
Rename-Item -Path "$TMP_DOWNLOAD_DIR/$actualDistributionDir" -NewName $MAVEN_HOME_NAME | Out-Null
try {
  Move-Item -Path "$TMP_DOWNLOAD_DIR/$MAVEN_HOME_NAME" -Destination $MAVEN_HOME_PARENT | Out-Null
} catch {
  if (! (Test-Path -Path "$MAVEN_HOME" -PathType Container)) {
    Write-Error "fail to move MAVEN_HOME"
  }
} finally {
  try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
  catch { Write-Warning "Cannot remove $TMP_DOWNLOAD_DIR" }
}

Write-Output "MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD"
</file>

<file path="README.md">
# analytics-service
</file>

<file path="src/main/java/com/analytics/controller/AnalyticsController.java">
package com.analytics.controller;

import com.analytics.dto.LinkAnalyticsResponse;
import com.analytics.service.AnalyticsService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;

@Tag(name = "Analytics API", description = "Аналитика по коротким ссылкам")
@RestController
@RequestMapping("/api/v1/analytics")
@CrossOrigin(origins = "*")
public class AnalyticsController {

    @Autowired
    private AnalyticsService analyticsService;

    @Operation(summary = "Полная аналитика по ссылке за период")
    @GetMapping("/{alias}")
    public ResponseEntity<LinkAnalyticsResponse> getAnalytics(
            @PathVariable String alias,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime start,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime end,
            @RequestParam(defaultValue = "false") boolean allTime) {

        LinkAnalyticsResponse analytics = analyticsService.getAnalytics(alias, start, end, allTime);
        return ResponseEntity.ok(analytics);
    }

    @GetMapping("/health")
    public ResponseEntity<String> health() {
        return ResponseEntity.ok("Analytics service is running");
    }
}
</file>

<file path="src/main/java/com/analytics/dto/LinkAnalyticsResponse.java">
package com.analytics.dto;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

public class LinkAnalyticsResponse {
    private String alias;

    private DateRange period;

    private long totalClicks;
    private long uniqueClicks;

    private List<StatItem> browserStats = new ArrayList<>();
    private List<StatItem> deviceStats = new ArrayList<>();
    private List<StatItem> topReferrers = new ArrayList<>();

    private GlobalStats globalStats;    

    public static class GlobalStats {
        private String grouping = "month";
        private List<TimeSeriesData> data = new ArrayList<>();

        public String getGrouping() { return grouping; }
        public void setGrouping(String grouping) { this.grouping = grouping; }

        public List<TimeSeriesData> getData() { return data; }
        public void setData(List<TimeSeriesData> data) { this.data = data; }
    }
    
    public static class DateRange {
        private LocalDateTime start;
        private LocalDateTime end;

        public LocalDateTime getStart() { return start; }
        public void setStart(LocalDateTime start) { this.start = start; }
        public LocalDateTime getEnd() { return end; }
        public void setEnd(LocalDateTime end) { this.end = end; }
    }

    public static class StatItem {
        private String name;
        private long count;
        private double percent;

        public StatItem(String name, long count, double percent) {
            this.name = name;
            this.count = count;
            this.percent = percent;
        }

        public StatItem() {}

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public long getCount() { return count; }
        public void setCount(long count) { this.count = count; }

        public double getPercent() { return percent; }
        public void setPercent(double percent) { this.percent = percent; }
    }

    public static class TimeSeries {
        private String grouping;
        private java.util.List<TimeSeriesData> data = new java.util.ArrayList<>();

        public String getGrouping() { return grouping; }
        public void setGrouping(String grouping) { this.grouping = grouping; }
        public java.util.List<TimeSeriesData> getData() { return data; }
        public void setData(java.util.List<TimeSeriesData> data) { this.data = data; }
    }

    public String getAlias() { return alias; }
    public void setAlias(String alias) { this.alias = alias; }

    public DateRange getPeriod() { return period; }
    public void setPeriod(DateRange period) { this.period = period; }

    public long getTotalClicks() { return totalClicks; }
    public void setTotalClicks(long totalClicks) { this.totalClicks = totalClicks; }

    public long getUniqueClicks() { return uniqueClicks; }
    public void setUniqueClicks(long uniqueClicks) { this.uniqueClicks = uniqueClicks; }

    public List<StatItem> getBrowserStats() { return browserStats; }
    public void setBrowserStats(List<StatItem> browserStats) { this.browserStats = browserStats; }

    public List<StatItem> getDeviceStats() { return deviceStats; }
    public void setDeviceStats(List<StatItem> deviceStats) { this.deviceStats = deviceStats; }

    public List<StatItem> getTopReferrers() { return topReferrers; }
    public void setTopReferrers(List<StatItem> topReferrers) { this.topReferrers = topReferrers; }

    public GlobalStats getGlobalStats() { return globalStats; }
    public void setGlobalStats(GlobalStats globalStats) { this.globalStats = globalStats; }
}
</file>

<file path="src/main/java/com/analytics/model/LinkClick.java">
package com.analytics.model;

import jakarta.persistence.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "link_clicks", indexes = {
    @Index(name = "idx_link_id", columnList = "linkId"),
    @Index(name = "idx_alias", columnList = "alias"),
    @Index(name = "idx_clicked_at", columnList = "clickedAt"),
    @Index(name = "idx_ip_hash", columnList = "ipHash")
})
public class LinkClick {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "link_id", nullable = false)
    private Long linkId;

    @Column(name = "alias", nullable = false, length = 50)
    private String alias;

    @Column(name = "original_url", length = 2048)
    private String originalUrl;

    // IP информация
    @Column(name = "ip_address", length = 45)
    private String ipAddress;

    @Column(name = "ip_hash", length = 64) // Хеш IP для подсчета уникальных
    private String ipHash;

    // Browser & Device информация
    @Column(name = "browser", length = 100)
    private String browser;

    @Column(name = "browser_version", length = 50)
    private String browserVersion;

    @Column(name = "operating_system", length = 100)
    private String operatingSystem;

    @Column(name = "device_type", length = 50)
    private String deviceType; // DESKTOP, MOBILE, TABLET, etc.

    @Column(name = "user_agent", length = 500)
    private String userAgent;

    // Referrer
    @Column(name = "referer", length = 500)
    private String referer;

    // Временные метки
    @Column(name = "clicked_at", nullable = false)
    private LocalDateTime clickedAt;

    @Column(name = "created_at", updatable = false)
    private LocalDateTime createdAt;

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        if (clickedAt == null) {
            clickedAt = LocalDateTime.now();
        }
    }

    public LinkClick() {}

    public LinkClick(Long linkId, String alias) {
        this.linkId = linkId;
        this.alias = alias;
        this.clickedAt = LocalDateTime.now();
    }
    
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public Long getLinkId() { return linkId; }
    public void setLinkId(Long linkId) { this.linkId = linkId; }

    public String getAlias() { return alias; }
    public void setAlias(String alias) { this.alias = alias; }

    public String getOriginalUrl() { return originalUrl; }
    public void setOriginalUrl(String originalUrl) { this.originalUrl = originalUrl; }

    public String getIpAddress() { return ipAddress; }
    public void setIpAddress(String ipAddress) { this.ipAddress = ipAddress; }

    public String getIpHash() { return ipHash; }
    public void setIpHash(String ipHash) { this.ipHash = ipHash; }

    public String getBrowser() { return browser; }
    public void setBrowser(String browser) { this.browser = browser; }

    public String getBrowserVersion() { return browserVersion; }
    public void setBrowserVersion(String browserVersion) { this.browserVersion = browserVersion; }

    public String getOperatingSystem() { return operatingSystem; }
    public void setOperatingSystem(String operatingSystem) { this.operatingSystem = operatingSystem; }

    public String getDeviceType() { return deviceType; }
    public void setDeviceType(String deviceType) { this.deviceType = deviceType; }

    public String getUserAgent() { return userAgent; }
    public void setUserAgent(String userAgent) { this.userAgent = userAgent; }

    public String getReferer() { return referer; }
    public void setReferer(String referer) { this.referer = referer; }

    public LocalDateTime getClickedAt() { return clickedAt; }
    public void setClickedAt(LocalDateTime clickedAt) { this.clickedAt = clickedAt; }

    public LocalDateTime getCreatedAt() { return createdAt; }
}
</file>

<file path="src/main/java/com/analytics/repository/LinkClickRepository.java">
package com.analytics.repository;

import com.analytics.model.LinkClick;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

@Repository
public interface LinkClickRepository extends JpaRepository<LinkClick, Long> {

       // Общее количество кликов по alias
       long countByAlias(String alias);

       // Уникальные клики (по IP hash)
       @Query("SELECT COUNT(DISTINCT lc.ipHash) FROM LinkClick lc WHERE lc.alias = :alias")
       long countUniqueClicksByAlias(@Param("alias") String alias);

       // Клики за период
       @Query("SELECT lc FROM LinkClick lc WHERE lc.alias = :alias " +
              "AND lc.clickedAt BETWEEN :startDate AND :endDate " +
              "ORDER BY lc.clickedAt DESC")
       List<LinkClick> findClicksByAliasAndDateRange(
              @Param("alias") String alias,
              @Param("startDate") LocalDateTime startDate,
              @Param("endDate") LocalDateTime endDate
       );

       // Статистика по браузерам
       @Query("SELECT lc.browser as browser, COUNT(lc) as count " +
              "FROM LinkClick lc WHERE lc.alias = :alias " +
              "GROUP BY lc.browser ORDER BY count DESC")
       List<Map<String, Object>> getBrowserStats(@Param("alias") String alias);

       // Статистика по устройствам
       @Query("SELECT lc.deviceType as deviceType, COUNT(lc) as count " +
              "FROM LinkClick lc WHERE lc.alias = :alias " +
              "GROUP BY lc.deviceType ORDER BY count DESC")
       List<Map<String, Object>> getDeviceStats(@Param("alias") String alias);

       // Статистика кликов по месяцам
       @Query("SELECT FUNCTION('DATE_TRUNC', 'month', lc.clickedAt) as month, COUNT(lc) as count " +
              "FROM LinkClick lc WHERE lc.alias = :alias " +
              "GROUP BY FUNCTION('DATE_TRUNC', 'month', lc.clickedAt) " +
              "ORDER BY month DESC")
       List<Map<String, Object>> getClicksByMonth(@Param("alias") String alias);

       // Статистика кликов по дням (последние N дней)
       @Query("SELECT FUNCTION('DATE', lc.clickedAt) as date, COUNT(lc) as count " +
              "FROM LinkClick lc WHERE lc.alias = :alias " +
              "AND lc.clickedAt >= :startDate " +
              "GROUP BY FUNCTION('DATE', lc.clickedAt) " +
              "ORDER BY date DESC")
       List<Map<String, Object>> getClicksByDay(
              @Param("alias") String alias,
              @Param("startDate") LocalDateTime startDate
       );

       // Топ referrers
       @Query("SELECT lc.referer as referer, COUNT(lc) as count " +
              "FROM LinkClick lc WHERE lc.alias = :alias AND lc.referer IS NOT NULL " +
              "GROUP BY lc.referer ORDER BY count DESC")
       List<Map<String, Object>> getTopReferrers(@Param("alias") String alias);


       @Query("SELECT COUNT(lc) FROM LinkClick lc WHERE lc.alias = :alias AND lc.clickedAt BETWEEN :start AND :end")
       long countByAliasInRange(@Param("alias") String alias, @Param("start") LocalDateTime start, @Param("end") LocalDateTime end);
       
       @Query("SELECT COUNT(DISTINCT lc.ipHash) FROM LinkClick lc WHERE lc.alias = :alias AND lc.clickedAt BETWEEN :start AND :end")
       long countUniqueByAliasInRange(@Param("alias") String alias, @Param("start") LocalDateTime start, @Param("end") LocalDateTime end);

       @Query("SELECT lc.browser AS browser, COUNT(lc) AS count FROM LinkClick lc WHERE lc.alias = :alias AND lc.clickedAt BETWEEN :start AND :end GROUP BY lc.browser ORDER BY count DESC")
       List<Map<String, Object>> getBrowserStatsInRange(@Param("alias") String alias, @Param("start") LocalDateTime start, @Param("end") LocalDateTime end);

       @Query("SELECT lc.deviceType AS deviceType, COUNT(lc) AS count FROM LinkClick lc WHERE lc.alias = :alias AND lc.clickedAt BETWEEN :start AND :end GROUP BY lc.deviceType ORDER BY count DESC")
       List<Map<String, Object>> getDeviceStatsInRange(@Param("alias") String alias, @Param("start") LocalDateTime start, @Param("end") LocalDateTime end);

       @Query("SELECT COALESCE(lc.referer, 'direct') AS referer, COUNT(lc) AS count FROM LinkClick lc WHERE lc.alias = :alias AND lc.clickedAt BETWEEN :start AND :end GROUP BY COALESCE(lc.referer, 'direct') ORDER BY count DESC LIMIT 10")
       List<Map<String, Object>> getTopReferrersInRange(@Param("alias") String alias, @Param("start") LocalDateTime start, @Param("end") LocalDateTime end);

       @Query("SELECT FUNCTION('DATE_TRUNC', 'hour', lc.clickedAt) AS hour, COUNT(lc) AS count FROM LinkClick lc WHERE lc.alias = :alias AND lc.clickedAt BETWEEN :start AND :end GROUP BY hour ORDER BY hour")
       List<Map<String, Object>> getClicksByHour(@Param("alias") String alias, @Param("start") LocalDateTime start, @Param("end") LocalDateTime end);

       @Query("SELECT FUNCTION('DATE', lc.clickedAt) AS date, COUNT(lc) AS count FROM LinkClick lc WHERE lc.alias = :alias AND lc.clickedAt BETWEEN :start AND :end GROUP BY date ORDER BY date")
       List<Map<String, Object>> getClicksByDay(@Param("alias") String alias, @Param("start") LocalDateTime start, @Param("end") LocalDateTime end);

       @Query("SELECT FUNCTION('DATE_TRUNC', 'month', lc.clickedAt) AS month, COUNT(lc) AS count FROM LinkClick lc WHERE lc.alias = :alias AND lc.clickedAt BETWEEN :start AND :end GROUP BY month ORDER BY month")
       List<Map<String, Object>> getClicksByMonthInRange(@Param("alias") String alias, @Param("start") LocalDateTime start, @Param("end") LocalDateTime end);
}
</file>

<file path="src/main/java/com/analytics/service/AnalyticsService.java">
package com.analytics.service;

import com.analytics.dto.LinkAnalyticsResponse;
import com.analytics.dto.TimeSeriesData;
import com.analytics.model.LinkClick;
import com.analytics.repository.LinkClickRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.net.URI;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.time.*;
import java.time.format.DateTimeFormatter;
import java.util.*;

@Service
public class AnalyticsService {

    @Autowired
    private LinkClickRepository clickRepository;

    @Autowired
    private UserAgentParserService userAgentParser;

    public LinkClick saveClick(Long linkId, String alias, String originalUrl,
                               String ipAddress, String userAgent, String referer) {
        LinkClick click = new LinkClick(linkId, alias);
        click.setOriginalUrl(originalUrl);
        click.setIpAddress(ipAddress);
        click.setIpHash(hashIp(ipAddress));
        click.setUserAgent(userAgent);
        click.setReferer(referer);

        Map<String, String> uaInfo = userAgentParser.parseUserAgent(userAgent);
        click.setBrowser(uaInfo.get("browser"));
        click.setBrowserVersion(uaInfo.get("browserVersion"));
        click.setOperatingSystem(uaInfo.get("operatingSystem"));
        click.setDeviceType(uaInfo.get("deviceType"));

        return clickRepository.save(click);
    }

    public LinkAnalyticsResponse getAnalytics(String alias, LocalDateTime start, LocalDateTime end, boolean allTime) {
        LinkAnalyticsResponse response = new LinkAnalyticsResponse();
        response.setAlias(alias);

        LocalDateTime actualStart;
        LocalDateTime actualEnd;

        if (allTime) {
            actualStart = LocalDateTime.of(1970, 1, 1, 0, 0);
            actualEnd = LocalDateTime.now().plusYears(10);
        } else {
            actualEnd = (end != null) ? end : LocalDateTime.now();
            actualStart = (start != null) ? start : actualEnd.minusDays(30);
        }

        LinkAnalyticsResponse.DateRange period = new LinkAnalyticsResponse.DateRange();
        period.setStart(actualStart);
        period.setEnd(actualEnd);
        response.setPeriod(period);

        long totalClicks = clickRepository.countByAliasInRange(alias, actualStart, actualEnd);
        response.setTotalClicks(totalClicks);

        long uniqueClicks = clickRepository.countUniqueByAliasInRange(alias, actualStart, actualEnd);
        response.setUniqueClicks(uniqueClicks);

        response.setBrowserStats(buildStats(clickRepository.getBrowserStatsInRange(alias, actualStart, actualEnd), totalClicks));
        response.setDeviceStats(buildStats(clickRepository.getDeviceStatsInRange(alias, actualStart, actualEnd), totalClicks));
        response.setTopReferrers(buildStats(clickRepository.getTopReferrersInRange(alias, actualStart, actualEnd), totalClicks));

        LinkAnalyticsResponse.GlobalStats globalStats = new LinkAnalyticsResponse.GlobalStats();
        globalStats.setData(convertToTimeSeries(clickRepository.getClicksByMonth(alias)));
        response.setGlobalStats(globalStats);

        return response;
    }

    private List<LinkAnalyticsResponse.StatItem> buildStats(List<Map<String, Object>> raw, long total) {
        return raw.stream()
            .map(row -> {
                String rawValue = row.entrySet().stream()
                    .filter(e -> !e.getKey().equals("count"))
                    .map(e -> Objects.toString(e.getValue(), null))
                    .findFirst()
                    .orElse(null);

                String name = normalizeName(rawValue);

                long count = ((Number) row.get("count")).longValue();
                double percent = total > 0 ? Math.round(count * 10000.0 / total) / 100.0 : 0.0;

                return new LinkAnalyticsResponse.StatItem(name, count, percent);
            })
            .sorted(Comparator.comparingLong((LinkAnalyticsResponse.StatItem s) -> s.getCount()).reversed())
            .toList();
    }

    private String normalizeName(String input) {
        if (input == null || input.isBlank()) {
            return "Direct";
        }

        String trimmed = input.trim();

        if (trimmed.contains("://") || trimmed.startsWith("www.")) {
            try {
                URI uri = new URI(trimmed);
                String host = uri.getHost();
                if (host != null) {
                    return host.startsWith("www.") ? host.substring(4) : host;
                }
            } catch (Exception e) {
            }
        }

        if ("Unknown".equalsIgnoreCase(trimmed)) {
            return "Other";
        }

        if ("direct".equalsIgnoreCase(trimmed)) {
            return "Direct";
        }

        return trimmed;
    }

    private List<TimeSeriesData> convertToTimeSeries(List<Map<String, Object>> stats) {
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM");

        return stats.stream()
                .map(row -> {
                    Object dateObj = row.entrySet().stream()
                            .filter(e -> !e.getKey().equals("count"))
                            .map(Map.Entry::getValue)
                            .findFirst()
                            .orElse(null);

                    long count = ((Number) row.get("count")).longValue();

                    String dateStr = "Unknown";
                    if (dateObj instanceof java.sql.Timestamp ts) {
                        dateStr = ts.toLocalDateTime().withDayOfMonth(1).format(formatter);
                    } else if (dateObj instanceof LocalDateTime ldt) {
                        dateStr = ldt.withDayOfMonth(1).format(formatter);
                    } else if (dateObj != null) {
                        dateStr = dateObj.toString().substring(0, 7);
                    }

                    return new TimeSeriesData(dateStr, count);
                })
                .sorted(Comparator.comparing(TimeSeriesData::getDate))
                .toList();
    }

    private String hashIp(String ip) {
        if (ip == null || ip.isBlank()) return "unknown";
        try {
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hash = digest.digest(ip.getBytes(StandardCharsets.UTF_8));
            return Base64.getEncoder().encodeToString(hash);
        } catch (Exception e) {
            return "error";
        }
    }
}
</file>

<file path="src/main/java/com/analytics/service/UserAgentParserService.java">
package com.analytics.service;

import eu.bitwalker.useragentutils.Browser;
import eu.bitwalker.useragentutils.DeviceType;
import eu.bitwalker.useragentutils.OperatingSystem;
import eu.bitwalker.useragentutils.UserAgent;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.Map;

@Service
public class UserAgentParserService {

    /**
     * Парсит User-Agent строку и возвращает информацию о браузере, ОС и устройстве
     */
    public Map<String, String> parseUserAgent(String userAgentString) {
        Map<String, String> result = new HashMap<>();

        if (userAgentString == null || userAgentString.isEmpty()) {
            result.put("browser", "Unknown");
            result.put("browserVersion", "Unknown");
            result.put("operatingSystem", "Unknown");
            result.put("deviceType", "Unknown");
            return result;
        }

        try {
            UserAgent userAgent = UserAgent.parseUserAgentString(userAgentString);

            // Browser
            Browser browser = userAgent.getBrowser();
            result.put("browser", browser.getName());
            result.put("browserVersion", userAgent.getBrowserVersion() != null 
                ? userAgent.getBrowserVersion().getVersion() 
                : "Unknown");

            // Operating System
            OperatingSystem os = userAgent.getOperatingSystem();
            result.put("operatingSystem", os.getName());

            // Device Type
            DeviceType deviceType = os.getDeviceType();
            result.put("deviceType", mapDeviceType(deviceType));

        } catch (Exception e) {
            result.put("browser", "Unknown");
            result.put("browserVersion", "Unknown");
            result.put("operatingSystem", "Unknown");
            result.put("deviceType", "Unknown");
        }

        return result;
    }

    /**
     * Маппинг типа устройства в удобный формат
     */
    private String mapDeviceType(DeviceType deviceType) {
        if (deviceType == null) {
            return "Other";
        }

        return switch (deviceType) {
            case COMPUTER -> "Desktop";
            case MOBILE -> "Mobile";
            case TABLET -> "Tablet";
            case DMR -> "Media Renderer";
            case GAME_CONSOLE -> "Game Console";
            case WEARABLE -> "Wearable";
            default -> "Other";
        };
    }
}
</file>

<file path="src/main/resources/application.properties">
# ===============================
# APPLICATION
# ===============================
spring.application.name=analytics-service

# ===============================
# SERVER
# ===============================
server.port=8081

# ===============================
# DATABASE
# ===============================
spring.datasource.url=${ANALYTICS_DB_URL:jdbc:postgresql://localhost:5433/analyticsdb}
spring.datasource.username=${ANALYTICS_DB_USERNAME:analyticsuser}
spring.datasource.password=${ANALYTICS_DB_PASSWORD:analyticspass}
spring.datasource.driver-class-name=org.postgresql.Driver

# ===============================
# JPA / HIBERNATE
# ===============================
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=true

# ===============================
# KAFKA CONSUMER
# ===============================
spring.kafka.bootstrap-servers=${KAFKA_BOOTSTRAP_SERVERS:redpanda:9092}
spring.kafka.consumer.group-id=analytics-group
spring.kafka.consumer.auto-offset-reset=earliest
spring.kafka.consumer.enable-auto-commit=true
spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.value-deserializer=org.springframework.kafka.support.serializer.JsonDeserializer
spring.kafka.consumer.properties.spring.json.trusted.packages=*

kafka.topic.link-clicks=link-clicks


# ===============================
# CONNECTION POOL
# ===============================
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=2
spring.datasource.hikari.connection-timeout=30000

# ===============================
# LOGGING
# ===============================
logging.level.root=INFO
logging.level.com.links.analytics=DEBUG
logging.level.org.springframework.kafka=INFO
logging.level.org.apache.kafka=WARN

# ===============================
# CORS
# ===============================
spring.web.cors.allowed-origins=*
spring.web.cors.allowed-methods=GET,POST,PUT,DELETE,OPTIONS
spring.web.cors.allowed-headers=*

# ===============================
# SWAGGER/OpenAPI
# ===============================
springdoc.api-docs.enabled=true
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.enabled=true
springdoc.swagger-ui.path=/docs
springdoc.info.title=Analytics Service API
springdoc.info.description=Сервис аналитики кликов по коротким ссылкам
springdoc.info.version=1.0.0
</file>

<file path=".gitignore">
HELP.md
target/
.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
!**/src/test/**/target/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/
build/
!**/src/main/**/build/
!**/src/test/**/build/

.vscode/
.env
</file>

<file path="compose.yaml">
# compose.yaml
services:
  analytics-db:
    image: postgres:15
    container_name: analytics-postgres-db
    environment:
      POSTGRES_DB: ${ANALYTICS_DB_NAME}
      POSTGRES_USER: ${ANALYTICS_DB_USERNAME}
      POSTGRES_PASSWORD: ${ANALYTICS_DB_PASSWORD}
    ports:
      - "5433:5432"
    volumes:
      - analytics-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - app-network 

  analytics-service:
    build: .
    container_name: analytics-service
    ports:
      - "8081:8081"
    environment:
      ANALYTICS_DB_URL: jdbc:postgresql://analytics-db:5432/${ANALYTICS_DB_NAME}
      ANALYTICS_DB_USERNAME: ${ANALYTICS_DB_USERNAME}
      ANALYTICS_DB_PASSWORD: ${ANALYTICS_DB_PASSWORD}
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
    depends_on:
      analytics-db:
        condition: service_healthy
    networks:
      - app-network        
      - kafka-network      
    restart: on-failure

volumes:
  analytics-pgdata:

networks:
  app-network:             
  kafka-network:
    external: true
</file>

<file path="pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.7</version>
        <relativePath/>
    </parent>
    
    <groupId>com.links</groupId>
    <artifactId>analytics-service</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>analytics-service</name>
    <description>Analytics service for link tracking</description>
    
    <properties>
        <java.version>21</java.version>
        <maven.compiler.source>21</maven.compiler.source>
        <maven.compiler.target>21</maven.compiler.target>
    </properties>
    
    <dependencies>
        <!-- Spring Boot -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- Kafka -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>
        
        <!-- PostgreSQL -->
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        
        <!-- User-Agent Parser -->
        <dependency>
            <groupId>eu.bitwalker</groupId>
            <artifactId>UserAgentUtils</artifactId>
            <version>1.21</version>
        </dependency>
        
        <!-- JSON -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
        </dependency>
        
        <dependency>
            <groupId>com.fasterxml.jackson.datatype</groupId>
            <artifactId>jackson-datatype-jsr310</artifactId>
        </dependency>
        
        <!-- Swagger/OpenAPI -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
            <version>2.6.0</version>
        </dependency>
        
        <!-- .env support -->
        <dependency>
            <groupId>io.github.cdimascio</groupId>
            <artifactId>dotenv-java</artifactId>
            <version>3.2.0</version>
        </dependency>
        
        <!-- Tests -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
</file>

</files>
