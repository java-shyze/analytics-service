# üìä Shyze Analytics Service

Backend-—Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–±–æ—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –ø–æ –∫–æ—Ä–æ—Ç–∫–∏–º —Å—Å—ã–ª–∫–∞–º. –ü–æ—Ç—Ä–µ–±–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ Kafka –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ REST API.

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã Shyze:

- **shyze-frontend** ‚Äî –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ React
- **shyze-links-service** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∞–º–∏
- **shyze-analytics-service** (—ç—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π) ‚Äî —Å–±–æ—Ä –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∫–ª–∏–∫–∞ –∏–∑ Kafka –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ü–∞—Ä—Å–∏–Ω–≥ User-Agent –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞, –û–° –∏ —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ IP –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –º–µ—Ç—Ä–∏–∫–∞–º
- REST API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∑–∞ –ª—é–±–æ–π –ø–µ—Ä–∏–æ–¥
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±—Ä–∞—É–∑–µ—Ä–∞–º, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º, –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º —Ç—Ä–∞—Ñ–∏–∫–∞
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã (–ø–æ —á–∞—Å–∞–º, –¥–Ω—è–º, –º–µ—Å—è—Ü–∞–º)
- OpenAPI/Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Java 21+
- Maven 3.9+
- Docker & Docker Compose
- PostgreSQL 15+
- Kafka/Redpanda (–¥–ª—è —Å–æ–±—ã—Ç–∏–π)

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone <repository-url>
cd shyze-analytics-service

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
cp .env.example .env
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` —Ñ–∞–π–ª:

```env
ANALYTICS_DB_URL=jdbc:postgresql://localhost:5433/analyticsdb
ANALYTICS_DB_NAME=analyticsdb
ANALYTICS_DB_USERNAME=analyticsuser
ANALYTICS_DB_PASSWORD=analyticspass
KAFKA_BOOTSTRAP_SERVERS=localhost:9092
```

### –ó–∞–ø—É—Å–∫

**–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–æ):**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL –∏ Kafka —á–µ—Ä–µ–∑ Docker
docker compose up -d analytics-db

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
./mvnw spring-boot:run
# –°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:8081
```

**Production —Å Docker:**
```bash
# –° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º justfile
just up          # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
just logs        # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
just rebuild     # –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
just down        # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Docker Compose
docker compose up -d
# –°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:8081
```

**–°–±–æ—Ä–∫–∞ JAR:**
```bash
./mvnw clean package -DskipTests
# JAR —Ñ–∞–π–ª: target/analytics-service-0.0.1-SNAPSHOT.jar
```

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ |
|-----------|------------|
| **Language** | Java 21 |
| **Framework** | Spring Boot 3.5.7 |
| **Database** | PostgreSQL 15, Spring Data JPA, Hibernate |
| **Message Broker** | Apache Kafka, Spring Kafka |
| **User-Agent Parsing** | UserAgentUtils 1.21 |
| **Build Tool** | Maven 3.9 |
| **API Documentation** | SpringDoc OpenAPI 3, Swagger UI |
| **Testing** | JUnit 5, Spring Kafka Test |
| **Config Management** | dotenv-java |
| **Containerization** | Docker, Docker Compose |


## üîå API Endpoints

### Analytics API

**–ë–∞–∑–æ–≤—ã–π URL:** `/api/v1/analytics`

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| `GET` | `/analytics/{alias}` | –ü–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –ø—Å–µ–≤–¥–æ–Ω–∏–º—É |
| `GET` | `/analytics/health` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞ |

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

```
GET /api/v1/analytics/{alias}?start=2024-01-01T00:00:00&end=2024-12-31T23:59:59&allTime=false
```

- `start` (optional) ‚Äî –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ (ISO 8601)
- `end` (optional) ‚Äî –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ (ISO 8601)
- `allTime` (optional) ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è (default: false)

### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞

```json
{
  "alias": "mylink",
  "period": {
    "start": "2024-01-01T00:00:00",
    "end": "2024-12-31T23:59:59"
  },
  "totalClicks": 1523,
  "uniqueClicks": 842,
  "browserStats": [
    {"name": "Chrome", "count": 856, "percent": 56.2},
    {"name": "Firefox", "count": 412, "percent": 27.0},
    {"name": "Safari", "count": 255, "percent": 16.8}
  ],
  "deviceStats": [
    {"name": "Desktop", "count": 923, "percent": 60.6},
    {"name": "Mobile", "count": 512, "percent": 33.6},
    {"name": "Tablet", "count": 88, "percent": 5.8}
  ],
  "topReferrers": [
    {"name": "google.com", "count": 645, "percent": 42.3},
    {"name": "Direct", "count": 523, "percent": 34.3},
    {"name": "twitter.com", "count": 355, "percent": 23.4}
  ],
  "globalStats": {
    "grouping": "month",
    "data": [
      {"date": "2024-01", "count": 123},
      {"date": "2024-02", "count": 156}
    ]
  }
}
```

### API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- **Swagger UI:** http://localhost:8081/docs
- **OpenAPI JSON:** http://localhost:8081/v3/api-docs

## üì® –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Kafka

–°–µ—Ä–≤–∏—Å –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ Kafka topic `link-clicks`:

**Event Schema (LinkClickEvent):**
```json
{
  "linkId": 123,
  "alias": "abc123",
  "originalUrl": "https://example.com",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0...",
  "referer": "https://google.com",
  "clickedAt": "2024-12-10T15:30:00"
}
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è:**
1. –°–æ–±—ã—Ç–∏–µ –ø–æ—Å—Ç—É–ø–∞–µ—Ç –∏–∑ **shyze-links-service**
2. –ü–∞—Ä—Å–∏—Ç—Å—è User-Agent –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞/–û–°/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
3. IP —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è (SHA-256) –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
4. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `link_clicks`

## üóÑ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã `link_clicks`

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `id` | BIGINT | Primary Key |
| `link_id` | BIGINT | ID —Å—Å—ã–ª–∫–∏ –∏–∑ Links Service |
| `alias` | VARCHAR(50) | –ü—Å–µ–≤–¥–æ–Ω–∏–º —Å—Å—ã–ª–∫–∏ |
| `original_url` | VARCHAR(2048) | –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL |
| `ip_address` | VARCHAR(45) | IP –∞–¥—Ä–µ—Å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è |
| `ip_hash` | VARCHAR(64) | SHA-256 —Ö–µ—à IP (–¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏) |
| `browser` | VARCHAR(100) | –ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ |
| `browser_version` | VARCHAR(50) | –í–µ—Ä—Å–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ |
| `operating_system` | VARCHAR(100) | –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ |
| `device_type` | VARCHAR(50) | –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (Desktop/Mobile/Tablet) |
| `user_agent` | VARCHAR(500) | –ü–æ–ª–Ω–∞—è User-Agent —Å—Ç—Ä–æ–∫–∞ |
| `referer` | VARCHAR(500) | –ò—Å—Ç–æ—á–Ω–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–∞ |
| `clicked_at` | TIMESTAMP | –í—Ä–µ–º—è –∫–ª–∏–∫–∞ |
| `created_at` | TIMESTAMP | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ |

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_link_id` ‚Äî –∏–Ω–¥–µ–∫—Å –Ω–∞ `link_id`
- `idx_alias` ‚Äî –∏–Ω–¥–µ–∫—Å –Ω–∞ `alias`
- `idx_clicked_at` ‚Äî –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- `idx_ip_hash` ‚Äî –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π

## üîç –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### –¢–∏–ø—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- Total Clicks ‚Äî –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- Unique Clicks ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ (–ø–æ IP hash)

**–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- Browser Stats ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –±—Ä–∞—É–∑–µ—Ä–∞–º
- Device Stats ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
- Top Referrers ‚Äî —Ç–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞
- Global Stats ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã (–ø–æ —á–∞—Å–∞–º/–¥–Ω—è–º/–º–µ—Å—è—Ü–∞–º)


## üîê –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å

–°–µ—Ä–≤–∏—Å —Å–æ–±–ª—é–¥–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏:
- IP –∞–¥—Ä–µ—Å–∞ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è (SHA-256) –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- –•–µ—à–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ IP –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ù–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö



## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü

```bash
curl "http://localhost:8081/api/v1/analytics/mylink?start=2024-11-01T00:00:00&end=2024-11-30T23:59:59"
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è

```bash
curl "http://localhost:8081/api/v1/analytics/mylink?allTime=true"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞

```bash
curl http://localhost:8081/api/v1/analytics/health
```

## üîÑ Workflow

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–µ
2. **Links Service** —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ Kafka
3. **Analytics Service** –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏–∑ Kafka
4. –ü–∞—Ä—Å–∏—Ç—Å—è User-Agent, —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è IP
5. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ PostgreSQL
6. Frontend –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É —á–µ—Ä–µ–∑ REST API
7. Analytics Service –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

